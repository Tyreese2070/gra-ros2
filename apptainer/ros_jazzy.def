Bootstrap: docker
From: osrf/ros:jazzy-desktop-full
%files
    # Get from: https://github.com/gazebosim/ros_gz/commit/0abd2b217d92ae7f65c1fa9f2a6464072217a038
    /local/data/<username>/ros_gz_bridge.py /local/data/<username>/ros_gz_bridge.py
 
    # Get from https://www.stereolabs.com/en-gb/developers/release/5.0
    /local/data/<username>/ZED_SDK_Ubuntu24_cuda12.8_tensorrt10.9_v5.0.5.zstd.run /local/data/<username>/ZED_SDK_Ubuntu24_cuda12.8_tensorrt10.9_v5.0.5.zstd.run
    # Get the cuda key ring: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
    /local/data/<username>/cuda-keyring_1.1-1_all.deb /local/data/<username>/cuda-keyring_1.1-1_all.deb
 
    # colcon workspace for package installations
    /local/data/<username>/colcon_ws/src /local/data/<username>/colcon_ws/src
 
%post
    # Simulation 
    apt-get -y update
    apt-get -y install vim
    apt-get -y install ros-jazzy-pcl-ros
    apt-get -y install python3-pip
    apt-get -y install ros-jazzy-ros-gz
    apt-get -y install python3.12-venv
    apt-get -y remove ros-jazzy-simulation
    apt-get install -y libgl1-mesa-dri libglx-mesa0
    apt-get install -y libvulkan1 vulkan-tools
    apt-get install -y mesa-vulkan-drivers
    apt-get install -y ros-jazzy-ackermann-msgs
 
    cp /local/data/<username>/ros_gz_bridge.py /opt/ros/jazzy/lib/python3.12/site-packages/ros_gz_bridge/actions/ros_gz_bridge.py
 
 
    curl https://packages.osrfoundation.org/gazebo.gpg --output /usr/share/keyrings/pkgs-osrf-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/pkgs-osrf-archive-keyring.gpg] http://packages.osrfoundation.org/gazebo/ubuntu-stable $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/gazebo-stable.list > /dev/null
    apt-get -y update
    apt-get -y install gz-harmonic
 
    apt-get install -y python3-colcon-common-extensions
    apt-get install -y python3-rosdep
    rosdep update


    # Bringup setup
    ## Install Zed 2i packages
 
    ### Cuda 12.8
    dpkg -i /local/data/<username>/cuda-keyring_1.1-1_all.deb
    apt-get -y update
    apt-get -y install cuda-toolkit-12-8
    ### 1. ZDK Install
    apt-get install -y zstd
    apt-get install -y libjpeg-turbo8-dev libturbojpeg  # ZDK dependency
 
    cd /local/data/<username>
    chmod +x ZED_SDK_Ubuntu24_cuda12.8_tensorrt10.9_v5.0.5.zstd.run
    ./ZED_SDK_Ubuntu24_cuda12.8_tensorrt10.9_v5.0.5.zstd.run -- silent
    ### 2. Install VLP-16
    apt-get install -y ros-jazzy-velodyne
 
    ## Build the zed_ros2_wrapper colcon packages
    cd /local/data/<username>/colcon_ws/src  # THIS MUST BE PRESENT BEFOREHAND
    cd ..
    rosdep update
    rosdep install --from-path src --ignore-src -r -y # install dependencies    

%environment
    export GZ_SIM_RESOURCE_PATH=~/colcon_ws/install/simulation/share/
 
    # CUDA paths
    export PATH=/usr/local/cuda-12.8/bin${PATH:+:${PATH}}
    export LD_LIBRARY_PATH=/usr/local/cuda-12.8/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
 
%runscript

%labels
   Prabodh Gyawali
